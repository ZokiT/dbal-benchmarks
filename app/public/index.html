<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js Example</title>
    <script src="charts/chart.js"></script>
    <style>
        canvas {
            max-width: 700px;
            max-height: 600px;
            float: left;
            padding-left: 60px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            margin-bottom: 20px; /* Add margin between the chart containers */
        }
    </style>
</head>
<body>

<div class="container" id="container"></div>

<script>

    const files = [
        'queryBuilderSelect.json',
        'queryBuilderInserts.json',
        'ORMInserts.json',
        'ORMSelect.json',
        'queryBuilderUpdate.json',
        'ORMUpdate.json',
        'ORMDelete.json'
    ];

    files.forEach(filename => fetchAndRenderChart(filename));

    function createOptions(title, textX, textY) {
        return {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: title
                },
            },
            interaction: {
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: textX
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: textY
                    }
                }
            }
        };
    }

    function fetchAndRenderChart(filename) {
        fetch('/charts/' + filename)
            .then(response => response.json())
            .then(jsonData => renderCharts(jsonData))
            .catch(error => console.error('Error fetching JSON:', error));
    }

    function createChartContainer() {
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        return chartContainer;
    }

    function createCanvas(id, width, height) {
        const canvas = document.createElement('canvas');
        canvas.id = id;
        canvas.width = width;
        canvas.height = height;
        return canvas;
    }

    function filterJsonDataAndPrepareDataSets(jsonData) {
        const datasets = [];
        const datasets2 = [];

        jsonData.forEach(result => {
            Object.entries(result.result).forEach(([key, value]) => {
                const methodName = value.shift();
                const execution = value.shift();
                const memory = value.shift();

                const dataset = datasets.find(dataset => dataset.label === methodName) || {
                    label: methodName,
                    data: [],
                    fill: false,
                    tension: 0.4,
                    cubicInterpolationMode: 'monotone'
                };

                const dataset2 = datasets2.find(dataset => dataset.label === methodName) || {
                    label: methodName,
                    data: [],
                    fill: false,
                    tension: 0.4,
                    cubicInterpolationMode: 'monotone'
                };

                dataset.data.push(execution);
                dataset2.data.push(memory);

                if (!datasets.includes(dataset)) {
                    datasets.push(dataset);
                }

                if (!datasets2.includes(dataset2)) {
                    datasets2.push(dataset2);
                }
            });
        });

        return [datasets, datasets2];
    }

    function renderCharts(jsonData) {
        const originalJsonData = JSON.parse(JSON.stringify(jsonData))
        if (jsonData.length === 1) {

            jsonData.forEach(result => {
                // Create a new chart container div
                const chartContainer = createChartContainer();

                // Create a canvas element for the chart
                const canvas1 = createCanvas(result.title + '1', 800, 800);
                const canvas2 = createCanvas(result.title + '2', 800, 800);

                // Append canvases to chart container
                chartContainer.appendChild(canvas1);
                chartContainer.appendChild(canvas2);

                // Append chart container to the main container
                document.getElementById('container').appendChild(chartContainer);

                const datasets1 = [];
                const datasets2 = [];

                for (const [key, value] of Object.entries(result.result)) {
                    const methodName = value.shift();
                    const execution = value.shift();
                    const memory = value.shift();

                    datasets1.push({
                        label: methodName,
                        data: [execution],
                        borderWidth: 2
                    });

                    datasets2.push({
                        label: methodName,
                        data: [memory],
                        borderWidth: 2
                    });
                }

                const data1 = {
                    labels: ['Avg. Execution Time (ms)'],
                    datasets: datasets1
                };

                const data2 = {
                    labels: ['Memory Usage (KB)'],
                    datasets: datasets2
                };

                const options = {
                    plugins: {
                        title: {
                            display: true,
                            text: result.title
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            },
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            barPercentage: 0.6
                        }
                    }
                };

                const ctx1 = document.getElementById(result.title + '1').getContext('2d');
                const myChart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: data1,
                    options: options
                });

                const ctx2 = document.getElementById(result.title + '2').getContext('2d');
                const myChart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: data2,
                    options: options
                });
            });

        }
        else {
            // charts for iterations
            jsonData.sort((a, b) => a.iterations - b.iterations);

            const title = jsonData[0].title; // Assuming all iterations share the same title

            const chartContainer = createChartContainer();

            const canvas1 = createCanvas(title + '1', 600, 600);
            const canvas2 = createCanvas(title + '2', 600, 600);

            chartContainer.appendChild(canvas1);
            chartContainer.appendChild(canvas2);

            document.getElementById('container').appendChild(chartContainer);


            const labels = jsonData.map(result => result.iterations);
            const [datasets, datasets2] = filterJsonDataAndPrepareDataSets(jsonData);

            const interPolarData = {
                labels: labels,
                datasets: datasets
            };

            const interPolarData2 = {
                labels: labels,
                datasets: datasets2
            };

            const ctxInterpolation = document.getElementById(title + '1').getContext('2d');
            const interpolarChart = new Chart(ctxInterpolation, {
                type: 'line',
                data: interPolarData,
                options: createOptions(title, 'Iterations', 'Avg. Execution Time (ms)'),
            });

            const ctxInterpolation2 = document.getElementById(title + '2').getContext('2d');
            const interpolarChart2 = new Chart(ctxInterpolation2, {
                type: 'line',
                data: interPolarData2,
                options: createOptions(title, 'Iterations', 'Memory Usage (KB)'),
            });
        }

        // chart for select limit
        if (originalJsonData[0].selectLimit !== undefined && originalJsonData[0].selectLimit > 0) {

            originalJsonData.sort((a, b) => a.selectLimit - b.selectLimit);

            const title = originalJsonData[0].title; // Assuming all iterations share the same title

            const chartContainer = createChartContainer();

            const canvas3 = createCanvas(title + '3', 600, 600);
            const canvas4 = createCanvas(title + '4', 600, 600);

            chartContainer.appendChild(canvas3);
            chartContainer.appendChild(canvas4);

            document.getElementById('container').appendChild(chartContainer);

            const labels2 = originalJsonData.map(result => result.selectLimit);
            const [datasets3, datasets4] = filterJsonDataAndPrepareDataSets(originalJsonData);

            const interPolarData3 = {
                labels: labels2,
                datasets: datasets3
            };

            const interPolarData4 = {
                labels: labels2,
                datasets: datasets4
            };

            const ctxInterpolation3 = document.getElementById(title + '3').getContext('2d');
            const interpolarChart = new Chart(ctxInterpolation3, {
                type: 'line',
                data: interPolarData3,
                options: createOptions(title, 'Select limit', 'Avg. Execution Time (ms)'),
            });

            const ctxInterpolation4 = document.getElementById(title + '4').getContext('2d');
            const interpolarChart2 = new Chart(ctxInterpolation4, {
                type: 'line',
                data: interPolarData4,
                options: createOptions(title, 'Select limit', 'Memory Usage (KB)'),
            });
        }

    }

</script>

</body>
</html>
