<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart.js Example</title>
    <script src="charts/chart.js"></script>
    <style>
        canvas {
            max-width: 700px;
            max-height: 600px;
            float: left;
            padding-left: 60px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            margin-bottom: 20px; /* Add margin between the chart containers */
        }
    </style>
</head>
<body>

<div class="container" id="container"></div>

<script>
    // Fetching JSON data from a file
    let files = [
        'queryBuilderSelect.json',
        'queryBuilderInserts.json',
        'ORMInserts.json'
    ];

    files.forEach(filename => {
        fetch('/charts/' + filename)
            .then(response => response.json())
            .then(jsonData => {

                if (jsonData.length === 1) {

                    // Create a new chart container div
                    const chartContainer1 = document.createElement('div');
                    chartContainer1.className = 'chart-container';

                    // Create a canvas element for the chart
                    const canvas1 = document.createElement('canvas');
                    canvas1.id = jsonData[0].title + 1;
                    canvas1.width = 800;
                    canvas1.height = 800;

                    // Append canvas to chart container
                    chartContainer1.appendChild(canvas1);

                    // Create a canvas element for the chart
                    const canvas2 = document.createElement('canvas');
                    canvas2.id = jsonData[0].title + 2;
                    canvas2.width = 800;
                    canvas2.height = 800;

                    // Append canvas to chart container
                    chartContainer1.appendChild(canvas2);

                    // Append chart container to the main container
                    document.getElementById('container').appendChild(chartContainer1);

                    let arrayDataset1 = [];
                    let arrayDataset2 = [];
                    for (const [key, value] of Object.entries(jsonData[0].result)) {
                        let methodName = value.shift()
                        arrayDataset1.push({
                            label: methodName,
                            data: [value.shift()],
                            borderWidth: 2
                        });
                        arrayDataset2.push({
                            label: methodName,
                            data: [value.shift()],
                            borderWidth: 2
                        });
                    }

                    data11 = {
                        labels: ['Avg. Execution Time (ms)'],
                        datasets: arrayDataset1
                    };

                    data12 = {
                        labels: ['Memory Usage (KB)'],
                        datasets: arrayDataset2
                    }

                    const options11 = {
                        plugins: {
                            title: {
                                display: true,
                                text: jsonData[0].title
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: Math.round,
                                font: {
                                    weight: 'bold'
                                },
                                display: true  // Ensure datalabels are displayed
                            }
                        },
                        scales: {
                            x: {
                                barPercentage: 0.6 // Adjust this value to control the width of the bars
                            }
                        }
                    };

                    const ctx11 = document.getElementById(jsonData[0].title + 1).getContext('2d');
                    const myChart11 = new Chart(ctx11, {
                        type: 'bar',
                        data: data11,
                        options: options11
                    });

                    const ctx12 = document.getElementById(jsonData[0].title + 2).getContext('2d');
                    const myChart12 = new Chart(ctx12, {
                        type: 'bar',
                        data: data12,
                        options: options11
                    });

                }
                else {
                    jsonData.sort((a,b) => (a.iterations > b.iterations) ? 1 : ((b.iterations > a.iterations) ? -1 : 0));

                    const labels = [];
                    const datasets = [];
                    const datasets2 = [];
                    let title = '';

                    jsonData.forEach(result => {

                        if (title === '') {
                            title = result.title;
                        }

                        labels.push(result.iterations);
                        for (const [key, value] of Object.entries(result.result)) {
                            let methodName = value.shift();
                            let execution = value.shift();
                            let memory = value.shift();

                            datasets.push([methodName, execution]);
                            datasets2.push([methodName, memory]);
                        }
                    });

                    const mappedData = {};
                    datasets.forEach(([label, value]) => {
                        if (!mappedData[label]) {
                            mappedData[label] = {
                                label: label,
                                data: [],
                                fill: false,
                                tension: 0.4,
                                cubicInterpolationMode: 'monotone'
                            };
                        }
                        mappedData[label].data.push(value);
                    });

                    const mappedData2 = {};
                    datasets2.forEach(([label, value]) => {
                        if (!mappedData2[label]) {
                            mappedData2[label] = {
                                label: label,
                                data: [],
                                fill: false,
                                tension: 0.4,
                                cubicInterpolationMode: 'monotone'
                            };
                        }
                        mappedData2[label].data.push(value);
                    });

                    const inter_polar_data = {
                        labels: labels,
                        datasets: Object.values(mappedData)
                    };

                    const inter_polar_data2 = {
                        labels: labels,
                        datasets: Object.values(mappedData2)
                    };


                    // Create a new chart container div
                    const chartContainer1 = document.createElement('div');
                    chartContainer1.className = 'chart-container';

                    // Create a canvas element for the chart
                    const canvas1 = document.createElement('canvas');
                    canvas1.id = jsonData[0].title;
                    canvas1.width = 600;
                    canvas1.height = 600;

                    // Append canvas to chart container
                    chartContainer1.appendChild(canvas1);

                    // Create a canvas element for the chart
                    const canvas2 = document.createElement('canvas');
                    canvas2.id = jsonData[0].title + 2;
                    canvas2.width = 600;
                    canvas2.height = 600;

                    // Append canvas to chart container
                    chartContainer1.appendChild(canvas2);

                    // Append chart container to the main container
                    document.getElementById('container').appendChild(chartContainer1);

                    const interpolar_config = {
                        type: 'line',
                        data: inter_polar_data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title
                                },
                            },
                            interaction: {
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Iterations'
                                    }
                                },
                                y: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Avg. Execution Time (ms)'
                                    }
                                }
                            }
                        },
                    };

                    const interpolar_config2 = {
                        type: 'line',
                        data: inter_polar_data2,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: title
                                },
                            },
                            interaction: {
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Iterations'
                                    }
                                },
                                y: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Memory Usage (KB)'
                                    }
                                }
                            }
                        },
                    };

                    var ctx_interpolation = document.getElementById(title).getContext('2d');
                    var interpolar_chart = new Chart(ctx_interpolation, interpolar_config);

                    var ctx_interpolation2 = document.getElementById(title + 2).getContext('2d');
                    var interpolar_chart2 = new Chart(ctx_interpolation2, interpolar_config2);
                }
            })
            .catch(error => console.error('Error fetching JSON:', error));
    });

</script>

<script>
    function fetchAndRenderChart(filename) {
        fetch('/charts/' + filename)
            .then(response => response.json())
            .then(jsonData => renderCharts(jsonData))
            .catch(error => console.error('Error fetching JSON:', error));
    }

    function createChartContainer() {
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        return chartContainer;
    }

    function createCanvas(id, width, height) {
        const canvas = document.createElement('canvas');
        canvas.id = id;
        canvas.width = width;
        canvas.height = height;
        return canvas;
    }

    function renderCharts(jsonData) {

        if (jsonData.length === 1) {

            jsonData.forEach(result => {
                // Create a new chart container div
                const chartContainer = createChartContainer();

                // Create a canvas element for the chart
                const canvas1 = createCanvas(result.title + '1', 800, 800);
                const canvas2 = createCanvas(result.title + '2', 800, 800);

                // Append canvases to chart container
                chartContainer.appendChild(canvas1);
                chartContainer.appendChild(canvas2);

                // Append chart container to the main container
                document.getElementById('container').appendChild(chartContainer);

                const datasets1 = [];
                const datasets2 = [];

                for (const [key, value] of Object.entries(result.result)) {
                    const methodName = value.shift();
                    const execution = value.shift();
                    const memory = value.shift();

                    datasets1.push({
                        label: methodName,
                        data: [execution],
                        borderWidth: 2
                    });

                    datasets2.push({
                        label: methodName,
                        data: [memory],
                        borderWidth: 2
                    });
                }

                const data1 = {
                    labels: ['Avg. Execution Time (ms)'],
                    datasets: datasets1
                };

                const data2 = {
                    labels: ['Memory Usage (KB)'],
                    datasets: datasets2
                };

                const options = {
                    plugins: {
                        title: {
                            display: true,
                            text: result.title
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            },
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            barPercentage: 0.6
                        }
                    }
                };

                const ctx1 = document.getElementById(result.title + '1').getContext('2d');
                const myChart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: data1,
                    options: options
                });

                const ctx2 = document.getElementById(result.title + '2').getContext('2d');
                const myChart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: data2,
                    options: options
                });
            });

        }
        else {
            jsonData.sort((a, b) => a.iterations - b.iterations);

            const title = jsonData[0].title; // Assuming all iterations share the same title

            const chartContainer = createChartContainer();

            const canvas1 = createCanvas(title + '1', 600, 600);
            const canvas2 = createCanvas(title + '2', 600, 600);

            chartContainer.appendChild(canvas1);
            chartContainer.appendChild(canvas2);

            document.getElementById('container').appendChild(chartContainer);

            const datasets = [];
            const datasets2 = [];
            const labels = jsonData.map(result => result.iterations);

            jsonData.forEach(result => {
                Object.entries(result.result).forEach(([key, value]) => {
                    const methodName = value.shift();
                    const execution = value.shift();
                    const memory = value.shift();

                    const dataset = datasets.find(dataset => dataset.label === methodName) || {
                        label: methodName,
                        data: [],
                        fill: false,
                        tension: 0.4,
                        cubicInterpolationMode: 'monotone'
                    };

                    const dataset2 = datasets2.find(dataset => dataset.label === methodName) || {
                        label: methodName,
                        data: [],
                        fill: false,
                        tension: 0.4,
                        cubicInterpolationMode: 'monotone'
                    };

                    dataset.data.push(execution);
                    dataset2.data.push(memory);

                    if (!datasets.includes(dataset)) {
                        datasets.push(dataset);
                    }

                    if (!datasets2.includes(dataset2)) {
                        datasets2.push(dataset2);
                    }
                });
            });

            const interPolarData = {
                labels: labels,
                datasets: datasets
            };

            const interPolarData2 = {
                labels: labels,
                datasets: datasets2
            };

            const options = {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: title
                    },
                },
                interaction: {
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Iterations'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Avg. Execution Time (ms)'
                        }
                    }
                }
            };

            const ctxInterpolation = document.getElementById(title + '1').getContext('2d');
            const interpolarChart = new Chart(ctxInterpolation, {
                type: 'line',
                data: interPolarData,
                options: options,
            });

            const ctxInterpolation2 = document.getElementById(title + '2').getContext('2d');
            const interpolarChart2 = new Chart(ctxInterpolation2, {
                type: 'line',
                data: interPolarData2,
                options: options,
            });
        }
    }

    const files = [
        'queryBuilderSelect.json',
        'queryBuilderInserts.json',
        'ORMInserts.json'
    ];

    files.forEach(filename => fetchAndRenderChart(filename));

</script>

</body>
</html>
